# SAM æ™ºèƒ½é…é¥°ç±»å‹æ¨æ–­ç³»ç»Ÿ

**ç‰ˆæœ¬**: 1.1.0
**å‘å¸ƒæ—¥æœŸ**: 2026-01-07
**åŠŸèƒ½**: è‡ªåŠ¨è¯†åˆ«ä»»æ„ä¸­è‹±æ–‡é…é¥°åç§°

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

æ™ºèƒ½é…é¥°ç±»å‹æ¨æ–­ç³»ç»Ÿå…è®¸ç”¨æˆ·ä½¿ç”¨**ä»»ä½•å¸¸è§çš„ä¸­æ–‡æˆ–è‹±æ–‡é…é¥°åç§°**ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶è½¬æ¢ä¸ºå¯¹åº”çš„æ£€æµ‹ç±»å‹ã€‚

### ä¸»è¦ä¼˜åŠ¿

- âœ… **æ— éœ€è®°å¿†å›ºå®šåç§°** - æ”¯æŒå›´å·¾ã€ä¸å·¾ã€æŠ«è‚©ã€å¢¨é•œç­‰å¸¸è§åˆ«å
- âœ… **ä¸­è‹±æ–‡é€šç”¨** - è‡ªåŠ¨è¯†åˆ«ä¸­æ–‡å’Œè‹±æ–‡è¾“å…¥
- âœ… **æ™ºèƒ½æ¨æ–­** - è¯­ä¹‰æ˜ å°„ + æ¨¡ç³ŠåŒ¹é…
- âœ… **è‡ªåŠ¨æ‰©å±•** - æœªçŸ¥ç±»å‹è‡ªåŠ¨ä½¿ç”¨é€šç”¨æ£€æµ‹æ¨¡å¼
- âœ… **ç”¨æˆ·å‹å¥½** - ç”¨æˆ·å¯ä»¥ç”¨è‡ªç„¶è¯­è¨€æè¿°é…é¥°

---

## ğŸ“š æ”¯æŒçš„é…é¥°ç±»å‹

### 1. å¸½å­ (hat)
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: å¸½å­ã€capã€å¤´å·¾ã€å‘å¸¦ã€å¤´é¥°ã€çš‡å† 
- è‹±æ–‡: hat, cap, headband, crown

**ç¤ºä¾‹:**
```
/milady_replace_sam 5050 å¸½å­ æœªæ¥ä¸»ä¹‰å…¨æ¯å¸½å­
/milady_replace_sam 5050 cap cyberpunk cap
/milady_replace_sam 5050 çš‡å†  é’»çŸ³çš‡å† 
```

---

### 2. çœ¼é•œ (glasses)
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: çœ¼é•œã€å¢¨é•œã€æŠ¤ç›®é•œã€å•ç‰‡çœ¼é•œ
- è‹±æ–‡: glasses, sunglasses, goggles, monocle

**ç¤ºä¾‹:**
```
/milady_replace_sam 5050 å¢¨é•œ èµ›åšæœ‹å…‹ç´«è‰²å¢¨é•œ
/milady_replace_sam 5050 sunglasses neon sunglasses
/milady_replace_sam 5050 æŠ¤ç›®é•œ é€æ˜æŠ¤ç›®é•œ
```

---

### 3. è€³ç¯ (earrings)
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: è€³ç¯ã€è€³é’‰ã€è€³å ã€è€³é¥°
- è‹±æ–‡: earrings, studs, dangles

**ç¤ºä¾‹:**
```
/milady_replace_sam 3274 è€³é’‰ é’»çŸ³è€³é’‰
/milady_replace_sam 3274 dangles long silver dangles
/milady_replace_sam 3274 è€³å  çç è€³å 
```

---

### 4. é¡¹é“¾ (necklace)
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: é¡¹é“¾ã€åŠå ã€é”éª¨é“¾ã€ç é“¾
- è‹±æ–‡: necklace, pendant, choker, beads

**ç¤ºä¾‹:**
```
/milady_replace_sam 8888 åŠå  é’»çŸ³åŠå é¡¹é“¾
/milady_replace_sam 8888 choker black choker
/milady_replace_sam 8888 é”éª¨é“¾ é‡‘è‰²é”éª¨é“¾
```

---

### 5. å›´å·¾ (scarf) â­ æ–°å¢
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: å›´å·¾ã€ä¸å·¾ã€é¢†å·¾ã€å›´è„–ã€æŠ«è‚©
- è‹±æ–‡: scarf, shawl

**ç¤ºä¾‹:**
```
/milady_replace_sam 5050 å›´å·¾ çº¢è‰²ä¸è´¨å›´å·¾
/milady_replace_sam 5050 scarf elegant silk scarf
/milady_replace_sam 5050 æŠ«è‚© ç¾Šæ¯›æŠ«è‚©
```

---

### 6. é¢éƒ¨é…é¥° (face_accessories)
**æ”¯æŒçš„è¾“å…¥:**
- ä¸­æ–‡: å£ç½©ã€é¢ç½©ã€é¢å…·ã€é¼»ç¯
- è‹±æ–‡: mask, nose_ring

**ç¤ºä¾‹:**
```
/milady_replace_sam 5050 å£ç½© é»‘è‰²å£ç½©
/milady_replace_sam 5050 mask futuristic mask
```

---

### 7. å…¶ä»–é…é¥° (other) - é€šç”¨æ¨¡å¼
**æ”¯æŒçš„è¾“å…¥:**
- ä»»ä½•æœªåœ¨ä¸Šè¿°åˆ—è¡¨ä¸­çš„é…é¥°åç§°

**è¡Œä¸º:**
- ä½¿ç”¨ SAM è‡ªåŠ¨æ£€æµ‹ï¼ˆä¸é™åˆ¶ä½ç½®å’Œå¤§å°ï¼‰
- é€‚ç”¨äºèƒ¸é’ˆã€æ‰‹é•¯ã€è…°å¸¦ç­‰éæ ‡å‡†é…é¥°

**ç¤ºä¾‹:**
```
/milady_replace_sam 5050 èƒ¸é’ˆ é’»çŸ³èƒ¸é’ˆ
/milady_replace_sam 5050 è…°å¸¦ é‡‘è‰²è…°å¸¦
/milady_replace_sam 5050 æ‰‹é•¯ é“¶è‰²æ‰‹é•¯
```

---

## ğŸ§  å·¥ä½œåŸç†

### 1. è¯­ä¹‰æ˜ å°„
ç³»ç»Ÿç»´æŠ¤ä¸€ä¸ªè¯­ä¹‰æ˜ å°„è¡¨ï¼Œå°†å¸¸è§é…é¥°åç§°æ˜ å°„åˆ°æ ‡å‡†ç±»å‹ï¼š

```python
SEMANTIC_MAPPING = {
    "å›´å·¾": "scarf", "scarf": "scarf", "ä¸å·¾": "scarf",
    "å¢¨é•œ": "glasses", "sunglasses": "glasses",
    "è€³é’‰": "earrings", "studs": "earrings",
    # ... æ›´å¤šæ˜ å°„
}
```

### 2. æ™ºèƒ½æ¨æ–­æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "å›´å·¾"
    â†“
1. è§„èŒƒåŒ–è¾“å…¥ (lowercase)
    â†“
2. ç›´æ¥æ˜ å°„æŸ¥æ‰¾
    âœ… æ‰¾åˆ°: "å›´å·¾" â†’ "scarf"
    â†“
3. è¿”å› ("scarf", "å›´å·¾")
```

```
ç”¨æˆ·è¾“å…¥: "èƒ¸é’ˆ" (æœªçŸ¥ç±»å‹)
    â†“
1. è§„èŒƒåŒ–è¾“å…¥
    â†“
2. ç›´æ¥æ˜ å°„æŸ¥æ‰¾
    âŒ æœªæ‰¾åˆ°
    â†“
3. æ¨¡ç³ŠåŒ¹é…
    âŒ æœªæ‰¾åˆ°
    â†“
4. Fallback åˆ° "other"
    â†“
5. è¿”å› ("other", "èƒ¸é’ˆ")
```

### 3. ä½ç½®å¯å‘å¼

æ¯ç§é…é¥°ç±»å‹éƒ½æœ‰å¯¹åº”çš„ä½ç½®èŒƒå›´ï¼Œç”¨äº SAM æ£€æµ‹ï¼š

| é…é¥°ç±»å‹ | Y èŒƒå›´ | X èŒƒå›´ | å¤§å°èŒƒå›´ |
|---------|--------|--------|----------|
| hat | 0-40% | 0-100% | 5-35% |
| glasses | 25-45% | 20-80% | 2-15% |
| earrings | 35-60% | 0-50% | 0.2-5% |
| necklace | 45-75% | 20-80% | 1-20% |
| **scarf** | **50-80%** | **15-85%** | **3-25%** |
| other | 0-100% | 0-100% | 0.1-50% |

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
$ python3 test_smart_inference.py

============================================================
ğŸ§ª æ™ºèƒ½é…é¥°ç±»å‹æ¨æ–­æµ‹è¯•
============================================================
âœ… 'å›´å·¾' â†’ scarf (å›´å·¾)
âœ… 'ä¸å·¾' â†’ scarf (å›´å·¾)
âœ… 'æŠ«è‚©' â†’ scarf (å›´å·¾)
âœ… 'å¢¨é•œ' â†’ glasses (çœ¼é•œ)
âœ… 'å¸½å­' â†’ hat (å¸½å­)
âœ… 'è€³é’‰' â†’ earrings (è€³ç¯)
âœ… 'é¡¹é“¾' â†’ necklace (é¡¹é“¾)
âœ… 'åŠå ' â†’ necklace (é¡¹é“¾)
âœ… 'scarf' â†’ scarf (å›´å·¾)
âœ… 'sunglasses' â†’ glasses (çœ¼é•œ)
âœ… 'cap' â†’ hat (å¸½å­)
âœ… 'necklace' â†’ necklace (é¡¹é“¾)
âœ… 'èƒ¸é’ˆ' â†’ other (èƒ¸é’ˆ)
âœ… 'æ‰‹é•¯' â†’ other (æ‰‹é•¯)

============================================================
æµ‹è¯•ç»“æœ: 14/14 é€šè¿‡
============================================================
```

**æˆåŠŸç‡**: 100%

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: å›´å·¾æ›¿æ¢

**å‘½ä»¤:**
```
/milady_replace_sam 5050 å›´å·¾ è„–å­ä¸Šå¢åŠ ä¸€ä¸ªå¤§çº¢è‰²å›´å·¾
```

**ç³»ç»Ÿå¤„ç†:**
1. æ™ºèƒ½æ¨æ–­: "å›´å·¾" â†’ scarf
2. SAM æ£€æµ‹å›´å·¾åŒºåŸŸ (50-80% Y, 15-85% X)
3. FLUX Fill Pro ç”Ÿæˆçº¢è‰²å›´å·¾

---

### ç¤ºä¾‹ 2: å¢¨é•œæ›¿æ¢

**å‘½ä»¤:**
```
/milady_replace_sam 5050 å¢¨é•œ èµ›åšæœ‹å…‹ç´«è‰²å¢¨é•œ
```

**ç³»ç»Ÿå¤„ç†:**
1. æ™ºèƒ½æ¨æ–­: "å¢¨é•œ" â†’ glasses
2. SAM æ£€æµ‹çœ¼é•œåŒºåŸŸ (25-45% Y, 20-80% X)
3. FLUX Fill Pro ç”Ÿæˆå¢¨é•œ

---

### ç¤ºä¾‹ 3: æœªçŸ¥ç±»å‹ï¼ˆèƒ¸é’ˆï¼‰

**å‘½ä»¤:**
```
/milady_replace_sam 5050 èƒ¸é’ˆ é’»çŸ³èƒ¸é’ˆ
```

**ç³»ç»Ÿå¤„ç†:**
1. æ™ºèƒ½æ¨æ–­: "èƒ¸é’ˆ" â†’ other (æœªçŸ¥ç±»å‹)
2. SAM è‡ªåŠ¨æ£€æµ‹ï¼ˆå…¨å›¾èŒƒå›´ï¼‰
3. FLUX Fill Pro ç”Ÿæˆèƒ¸é’ˆ

âš ï¸ **æ³¨æ„**: æœªçŸ¥ç±»å‹çš„æ£€æµ‹ç²¾åº¦å¯èƒ½è¾ƒä½ï¼Œå»ºè®®ä½¿ç”¨å·²çŸ¥ç±»å‹è·å¾—æœ€ä½³æ•ˆæœã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨å·²çŸ¥ç±»å‹
**æ¨è:**
```
/milady_replace_sam 5050 å›´å·¾ çº¢è‰²ä¸è´¨å›´å·¾
/milady_replace_sam 5050 å¢¨é•œ èµ›åšæœ‹å…‹å¢¨é•œ
```

**ä¸æ¨èï¼ˆä½†å¯ç”¨ï¼‰:**
```
/milady_replace_sam 5050 èƒ¸é’ˆ é’»çŸ³èƒ¸é’ˆ  # æœªçŸ¥ç±»å‹ï¼Œç²¾åº¦è¾ƒä½
```

### 2. è¯¦ç»†çš„è‹±æ–‡æè¿°
**å¥½:**
```
/milady_replace_sam 5050 scarf elegant red silk scarf with tassels, highly detailed
```

**å·®:**
```
/milady_replace_sam 5050 å›´å·¾ çº¢è‰²  # æè¿°å¤ªç®€å•
```

### 3. æŸ¥çœ‹ç»ˆç«¯æ—¥å¿—
ç³»ç»Ÿä¼šåœ¨ç»ˆç«¯æ˜¾ç¤ºæ¨æ–­ç»“æœï¼š
```
ğŸ¯ æ™ºèƒ½æ¨æ–­: 'å›´å·¾' â†’ scarf (å›´å·¾)
ğŸ”„ è¿è¡Œ SAM-2 æ¨¡å‹...
âœ… SAM æ£€æµ‹åˆ° 18 ä¸ªæ©ç 
âœ… æ£€æµ‹åˆ°å›´å·¾:
   ä½ç½®åˆ†æ•°: 0.950
   IoU: 0.425
   ç»¼åˆåˆ†æ•°: 0.688
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### ä»£ç ä½ç½®

**SAM Detector** (`src/meme/sam_detector.py`):
```python
@classmethod
def infer_accessory_type(cls, user_input: str) -> Tuple[str, str]:
    """
    Intelligent accessory type inference from user input.

    Returns:
        Tuple of (inferred_type, display_name)
    """
    # è§„èŒƒåŒ–è¾“å…¥
    normalized = user_input.strip().lower()

    # ç›´æ¥æ˜ å°„æŸ¥æ‰¾
    if normalized in cls.SEMANTIC_MAPPING:
        inferred_type = cls.SEMANTIC_MAPPING[normalized]
        display_name = cls.POSITION_HINTS[inferred_type]["name"]
        return inferred_type, display_name

    # æ¨¡ç³ŠåŒ¹é…
    for keyword, accessory_type in cls.SEMANTIC_MAPPING.items():
        if keyword in normalized or normalized in keyword:
            return accessory_type, cls.POSITION_HINTS[accessory_type]["name"]

    # Fallback åˆ° other
    return "other", user_input
```

**Lark Bot** (`src/bots/lark_meme_bot.py`):
```python
# æ™ºèƒ½é…é¥°ç±»å‹æ¨æ–­
from src.meme.sam_detector import SAMDetector
original_accessory = accessory_type
accessory_type, display_name = SAMDetector.infer_accessory_type(accessory_type)

if original_accessory.lower() != accessory_type:
    print(f"ğŸ¯ æ™ºèƒ½æ¨æ–­: '{original_accessory}' â†’ {accessory_type} ({display_name})")
```

---

## ğŸ“ˆ æœªæ¥æ‰©å±•

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰

1. **æ·»åŠ æ›´å¤šé…é¥°ç±»å‹**
   - æ‰‹å¥—ã€è¢œå­ã€é‹å­
   - èƒŒåŒ…ã€è…°å¸¦
   - å‘é¥°ã€å‘å¤¹

2. **æ”¯æŒç»„åˆé…é¥°**
   - "å¢¨é•œ+å¸½å­"
   - "å›´å·¾+é¡¹é“¾"

### ä¸­æœŸï¼ˆ1-3 ä¸ªæœˆï¼‰

1. **å¤šè¯­è¨€æ”¯æŒ**
   - æ—¥æ–‡ã€éŸ©æ–‡é…é¥°åç§°
   - è‡ªåŠ¨è¯­è¨€æ£€æµ‹

2. **ç”¨æˆ·è‡ªå®šä¹‰æ˜ å°„**
   - å…è®¸ç”¨æˆ·æ·»åŠ è‡ªå·±çš„é…é¥°åˆ«å
   - ä¿å­˜åˆ°é…ç½®æ–‡ä»¶

### é•¿æœŸï¼ˆ3-6 ä¸ªæœˆï¼‰

1. **AI è¯­ä¹‰ç†è§£**
   - ä½¿ç”¨ NLP æ¨¡å‹ç†è§£æè¿°
   - "åœ¨è„–å­ä¸ŠåŠ ä¸ªä¸œè¥¿" â†’ è‡ªåŠ¨è¯†åˆ«ä¸º scarf æˆ– necklace

2. **è§†è§‰å¼•å¯¼**
   - ç”¨æˆ·ç‚¹å‡»å›¾ç‰‡ä½ç½®
   - è‡ªåŠ¨è¯†åˆ«é…é¥°ç±»å‹

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **æ¨¡ç³ŠåŒ¹é…å¯èƒ½è¯¯åˆ¤**
   - "å¸½å­å›´å·¾" å¯èƒ½è¢«è¯†åˆ«ä¸º "å¸½å­"
   - å»ºè®®ä½¿ç”¨å•ä¸€é…é¥°åç§°

2. **æœªçŸ¥ç±»å‹æ£€æµ‹ç²¾åº¦è¾ƒä½**
   - "èƒ¸é’ˆ"ã€"æ‰‹é•¯" ç­‰éæ ‡å‡†é…é¥°
   - ä¾èµ– SAM å…¨å›¾æ£€æµ‹ï¼Œå¯èƒ½ä¸å‡†ç¡®

3. **ä¸­è‹±æ–‡æ··åˆæ”¯æŒæœ‰é™**
   - "scarfå›´å·¾" å¯èƒ½æ— æ³•è¯†åˆ«
   - å»ºè®®ä½¿ç”¨çº¯ä¸­æ–‡æˆ–çº¯è‹±æ–‡

---

## ğŸ“ æ”¯æŒ

### æµ‹è¯•æ™ºèƒ½æ¨æ–­

```bash
cd /Users/pengsun/ai-content-studio
python3 test_smart_inference.py
```

### æ·»åŠ æ–°çš„é…é¥°ç±»å‹

ç¼–è¾‘ `src/meme/sam_detector.py`:

```python
SEMANTIC_MAPPING = {
    # ... ç°æœ‰æ˜ å°„

    # æ·»åŠ æ–°ç±»å‹
    "æ–°é…é¥°": "new_type",
}

POSITION_HINTS = {
    # ... ç°æœ‰æç¤º

    # æ·»åŠ æ–°ç±»å‹çš„ä½ç½®å¯å‘å¼
    "new_type": {
        "y_range": (0.0, 1.0),
        "x_range": (0.0, 1.0),
        "size_range": (0.01, 0.5),
        "name": "æ–°é…é¥°"
    }
}
```

---

## ğŸ‰ æ€»ç»“

æ™ºèƒ½é…é¥°ç±»å‹æ¨æ–­ç³»ç»Ÿè®© SAM åŠŸèƒ½æ›´åŠ **ç”¨æˆ·å‹å¥½**ï¼š

- âœ… æ— éœ€è®°å¿†å›ºå®šåç§°
- âœ… æ”¯æŒä¸­è‹±æ–‡ + å¸¸è§åˆ«å
- âœ… è‡ªåŠ¨æ‰©å±•åˆ°æœªçŸ¥ç±»å‹
- âœ… 100% æµ‹è¯•é€šè¿‡ç‡

ç°åœ¨ç”¨æˆ·å¯ä»¥ç”¨æœ€è‡ªç„¶çš„æ–¹å¼æè¿°é…é¥°ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç†è§£å¹¶å¤„ç†ï¼

---

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
